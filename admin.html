<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - HIHSM</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&family=Fredoka:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- SheetJS for Excel Operations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --primary: #0f766e; --bg: #f0f9ff; }
        body { font-family: 'Quicksand', sans-serif; background-color: var(--bg); color: #334155; }
        h1, h2, h3, h4, .brand { font-family: 'Fredoka', sans-serif; }
        
        .nav-item { transition: all 0.2s; border-left: 4px solid transparent; }
        .nav-item:hover { background-color: #f1f5f9; color: var(--primary); }
        .nav-item.active { background-color: #ccfbf1; color: var(--primary); border-left-color: var(--primary); font-weight: 700; }
        
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.8); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col">

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-2 pointer-events-none"></div>

    <!-- Login View -->
    <div id="login-view" class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-teal-50 to-slate-200 absolute inset-0 z-50">
        <div class="glass-card p-10 rounded-3xl shadow-2xl w-full max-w-md text-center">
            <div class="w-20 h-20 bg-teal-600 text-white rounded-2xl flex items-center justify-center text-4xl mx-auto mb-6 shadow-lg shadow-teal-200">
                <i class="fas fa-shield-alt"></i>
            </div>
            <h2 class="text-3xl font-bold text-slate-800 brand">Admin Portal</h2>
            <p class="text-slate-500 mb-8 font-medium">Secure Access Only</p>
            
            <form onsubmit="adminLogin(event)" class="space-y-4 text-left">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Email</label>
                    <input id="adm-email" class="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-teal-400 outline-none transition" placeholder="admin@school.com" value="admin@school.com">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Password</label>
                    <input id="adm-pass" type="password" class="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-teal-400 outline-none transition" placeholder="••••••" value="admin123">
                </div>
                <button class="w-full bg-teal-600 text-white py-3.5 rounded-xl font-bold hover:bg-teal-700 transition shadow-lg hover:shadow-teal-200/50">Login</button>
            </form>
            
            <div class="mt-8 pt-6 border-t border-slate-100 flex justify-between items-center text-xs font-bold text-slate-400">
                <a href="index.html" class="hover:text-teal-600 flex items-center gap-1 transition"><i class="fas fa-arrow-left"></i> Website</a>
                <button onclick="hardReset()" class="hover:text-red-500 transition">Reset System</button>
            </div>
        </div>
    </div>

    <!-- Dashboard Layout -->
    <div id="dash-view" class="hidden flex h-screen">
        
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r border-slate-200 flex flex-col shadow-xl z-20">
            <div class="p-6 border-b border-slate-100 flex items-center gap-3">
                <div class="w-10 h-10 bg-teal-600 rounded-xl flex items-center justify-center text-white font-bold text-lg shadow-lg">HI</div>
                <div><h2 class="font-bold text-slate-800 text-lg brand">HIHSM</h2><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Control Panel</p></div>
            </div>
            
            <nav class="flex-1 p-4 space-y-1 overflow-y-auto custom-scrollbar">
                <p class="px-4 mt-2 mb-2 text-[10px] font-bold text-slate-400 uppercase tracking-widest">Main</p>
                <button onclick="showTab('home')" id="nav-home" class="nav-item w-full text-left px-4 py-3 rounded-xl text-slate-600 font-medium flex items-center gap-3"><i class="fas fa-th-large w-5 text-center"></i> Overview</button>
                <button onclick="showTab('cms')" id="nav-cms" class="nav-item w-full text-left px-4 py-3 rounded-xl text-slate-600 font-medium flex items-center gap-3"><i class="fas fa-layer-group w-5 text-center"></i> Website CMS</button>
                <button onclick="showTab('results')" id="nav-results" class="nav-item w-full text-left px-4 py-3 rounded-xl text-slate-600 font-medium flex items-center gap-3"><i class="fas fa-poll w-5 text-center"></i> Results</button>
                
                <p class="px-4 mt-6 mb-2 text-[10px] font-bold text-slate-400 uppercase tracking-widest">Academic</p>
                <button onclick="showTab('teachers')" id="nav-teachers" class="nav-item w-full text-left px-4 py-3 rounded-xl text-slate-600 font-medium flex items-center gap-3"><i class="fas fa-chalkboard-teacher w-5 text-center"></i> Teachers</button>
                <button onclick="showTab('classes')" id="nav-classes" class="nav-item w-full text-left px-4 py-3 rounded-xl text-slate-600 font-medium flex items-center gap-3"><i class="fas fa-school w-5 text-center"></i> Classes</button>
                <button onclick="showTab('students')" id="nav-students" class="nav-item w-full text-left px-4 py-3 rounded-xl text-slate-600 font-medium flex items-center gap-3"><i class="fas fa-user-graduate w-5 text-center"></i> Students</button>
                
                <p class="px-4 mt-6 mb-2 text-[10px] font-bold text-slate-400 uppercase tracking-widest">Finance</p>
                <a href="subscription.html" class="nav-item w-full text-left px-4 py-3 rounded-xl text-slate-600 font-medium flex items-center gap-3 hover:text-teal-700 transition"><i class="fas fa-wallet w-5 text-center"></i> Varisanghya</a>

                <p class="px-4 mt-6 mb-2 text-[10px] font-bold text-slate-400 uppercase tracking-widest">Settings</p>
                <button onclick="showTab('profile')" id="nav-profile" class="nav-item w-full text-left px-4 py-3 rounded-xl text-slate-600 font-medium flex items-center gap-3"><i class="fas fa-cog w-5 text-center"></i> Configuration</button>
            </nav>
            
            <div class="p-4 border-t border-slate-100">
                <button onclick="logout()" class="w-full text-left px-4 py-3 text-red-500 font-bold hover:bg-red-50 rounded-xl transition flex items-center gap-3"><i class="fas fa-sign-out-alt w-5 text-center"></i> Sign Out</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-screen overflow-hidden bg-slate-50 relative">
            <header class="bg-white border-b border-slate-200 px-8 py-4 flex justify-between items-center shadow-sm z-10">
                <div>
                    <h1 id="page-title" class="text-xl font-bold text-slate-800 brand">Dashboard</h1>
                    <p id="page-desc" class="text-xs text-slate-500 font-medium">Welcome back, Admin</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="bg-teal-50 text-teal-700 px-3 py-1 rounded-full text-xs font-bold border border-teal-100 flex items-center gap-2">
                        <span class="w-2 h-2 bg-teal-500 rounded-full animate-pulse"></span> System Online
                    </div>
                </div>
            </header>
            <div id="content-area" class="flex-1 overflow-y-auto p-8 fade-in pb-32">
                <!-- Content injected via JS -->
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="modal-sub" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100">
            <div class="bg-slate-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800">Manage Subjects</h3>
                <button onclick="document.getElementById('modal-sub').classList.add('hidden')" class="text-slate-400 hover:text-red-500 transition"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Subject List</label>
                    <div id="sub-list" class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar border rounded-xl p-2 bg-slate-50"></div>
                </div>
                <div class="pt-4 border-t border-slate-100">
                    <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Add New Subject</label>
                    <div class="flex gap-2">
                        <input id="new-sub" placeholder="Name (e.g. English)" class="border p-2.5 rounded-lg flex-1 text-sm focus:ring-2 focus:ring-teal-100 outline-none">
                        <input id="new-sub-pass" type="number" placeholder="Pass Mark" class="border p-2.5 rounded-lg w-24 text-sm focus:ring-2 focus:ring-teal-100 outline-none">
                        <button onclick="addSubject()" class="bg-teal-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-teal-700 shadow-md">Add</button>
                    </div>
                </div>
            </div>
            <input type="hidden" id="active-cid">
        </div>
    </div>

    <!-- Scripts -->
    <script>
        const DB_KEY = 'hihsm_data_ultimate';
        let editMode = null;
        let lastPassMark = localStorage.getItem('hihsm_last_pass') || 35;

        // --- CORE DATABASE ---
        function getDB() {
            let data; 
            try { data = JSON.parse(localStorage.getItem(DB_KEY)); } catch(e) { data = null; }
            if(!data) data = {};
            ['teachers', 'classes', 'students', 'subjects', 'results'].forEach(k => { if(!data[k]) data[k] = []; });
            if(!data.admin) data.admin = { email: 'admin@school.com', pass: 'admin123' };
            if(!data.settings) data.settings = { name: "HIHSM" };
            
            if(!data.website) {
                data.website = {
                    notifications: [{id:'n1', text:"Welcome to the new portal!", link:"#contact", date: new Date().toLocaleDateString()}],
                    hero: { badge: "Admissions Open", title: "Empowering <br>Future Leaders", desc: "A legacy of excellence combining modern academic rigor with timeless moral values." },
                    about: { title: "A Tradition of Excellence", desc: "Building character.", features: [] },
                    stats: { students: 1200, faculty: 50, years: 35, pass: 100 },
                    contact: { address: "Malappuram, Kerala", phone: "+91 98765 43210", email: "info@hihsm.com", mapUrl: "" },
                    faculty: [], gallery: []
                };
                localStorage.setItem(DB_KEY, JSON.stringify(data));
            }
            return data;
        }

        function saveDB(d) { localStorage.setItem(DB_KEY, JSON.stringify(d)); }
        function genId() { return Math.random().toString(36).substr(2, 9); }
        function showToast(msg) {
            const el = document.createElement('div');
            el.className = 'p-4 bg-slate-800 text-white rounded-lg fixed top-5 right-5 shadow-2xl z-50 flex items-center gap-3 animate-bounce';
            el.innerHTML = `<i class="fas fa-check-circle text-teal-400"></i> <span class="font-bold text-sm">${msg}</span>`;
            document.getElementById('toast-container').appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }
        function el(id) { return document.getElementById(id); }

        // --- AUTH ---
        function adminLogin(e) {
            e.preventDefault();
            const db = getDB();
            if(el('adm-email').value === db.admin.email && el('adm-pass').value === db.admin.pass) {
                el('login-view').classList.add('hidden');
                el('dash-view').classList.remove('hidden');
                showTab('home');
            } else alert('Invalid Credentials');
        }
        function logout() { location.reload(); }
        function hardReset() { if(confirm("Factory Reset? All data will be wiped.")) { localStorage.removeItem(DB_KEY); location.reload(); } }

        // --- TABS & UI ---
        function showTab(tab) {
            const db = getDB();
            const area = el('content-area');
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            if(el('nav-'+tab)) el('nav-'+tab).classList.add('active');
            el('page-title').innerText = tab === 'cms' ? "Website CMS" : tab.charAt(0).toUpperCase() + tab.slice(1);
            editMode = null;

            // HOME
            if(tab === 'home') {
                area.innerHTML = `
                <div class="grid md:grid-cols-3 gap-6 animate-in">
                    <div class="bg-white p-6 rounded-2xl border-l-4 border-teal-500 shadow-sm flex justify-between items-center transition hover:shadow-md"><div><div class="text-4xl font-bold text-slate-800">${db.teachers.length}</div><div class="text-slate-500 text-xs font-bold uppercase tracking-wider">Teachers</div></div><div class="w-12 h-12 bg-teal-50 text-teal-600 rounded-full flex items-center justify-center text-xl"><i class="fas fa-chalkboard-teacher"></i></div></div>
                    <div class="bg-white p-6 rounded-2xl border-l-4 border-blue-500 shadow-sm flex justify-between items-center transition hover:shadow-md"><div><div class="text-4xl font-bold text-slate-800">${db.classes.length}</div><div class="text-slate-500 text-xs font-bold uppercase tracking-wider">Classes</div></div><div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center text-xl"><i class="fas fa-school"></i></div></div>
                    <div class="bg-white p-6 rounded-2xl border-l-4 border-purple-500 shadow-sm flex justify-between items-center transition hover:shadow-md"><div><div class="text-4xl font-bold text-slate-800">${db.students.length}</div><div class="text-slate-500 text-xs font-bold uppercase tracking-wider">Students</div></div><div class="w-12 h-12 bg-purple-50 text-purple-600 rounded-full flex items-center justify-center text-xl"><i class="fas fa-user-graduate"></i></div></div>
                </div>
                <div class="mt-8 bg-gradient-to-r from-slate-800 to-slate-900 rounded-2xl p-8 text-white shadow-xl flex justify-between items-center">
                    <div>
                        <h3 class="text-2xl font-bold mb-2">Welcome to ${db.settings.name} Admin</h3>
                        <p class="text-slate-400 text-sm max-w-lg">Manage your institution efficiently. Use the sidebar to navigate through modules.</p>
                    </div>
                    <i class="fas fa-user-shield text-6xl text-slate-700"></i>
                </div>`;
            }

            // RESULTS
            else if(tab === 'results') {
                const pending = db.results.filter(r => !r.isPublished);
                const grouped = pending.reduce((acc, r) => {
                    const key = r.examName + '|' + r.classId;
                    if(!acc[key]) acc[key] = { name: r.examName, classId: r.classId, count: 0, date: r.date };
                    acc[key].count++; return acc;
                }, {});
                const cOpts = db.classes.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
                area.innerHTML = `<div class="space-y-8 max-w-5xl"><div class="bg-white p-6 rounded-2xl shadow-sm border-t-4 border-yellow-500"><h3 class="font-bold text-lg mb-4 text-yellow-700 flex items-center gap-2"><i class="fas fa-clipboard-check"></i> Pending Approvals</h3>${Object.keys(grouped).length === 0 ? '<p class="text-gray-400 text-sm italic">No pending results.</p>' : `<div class="space-y-3">${Object.entries(grouped).map(([k, v]) => { const cName = db.classes.find(c=>c.id===v.classId)?.name || 'Unknown'; return `<div class="flex justify-between items-center p-4 bg-yellow-50 border border-yellow-100 rounded-xl shadow-sm"><div><span class="font-bold text-gray-800 text-lg block">${v.name}</span> <span class="text-xs text-gray-500 font-mono">${v.date}</span> <span class="text-sm text-gray-600 ml-2">Class: <b>${cName}</b></span> <span class="text-xs bg-white px-2 py-1 rounded border ml-2">${v.count} Students</span></div><button onclick="approveResults('${v.name}', '${v.classId}')" class="bg-green-600 text-white px-5 py-2 rounded-lg text-sm font-bold hover:bg-green-700 shadow-md transition">Approve & Publish</button></div>`; }).join('')}</div>`}</div><div class="bg-white p-6 rounded-2xl shadow border-t-4 border-teal-600"><h3 class="font-bold text-lg mb-4 text-teal-800 flex items-center gap-2"><i class="fas fa-keyboard"></i> Direct Mark Entry</h3><div class="flex gap-4 mb-4 bg-teal-50 p-4 rounded-xl"><select id="mk-cid" class="border p-2.5 rounded-lg bg-white text-sm focus:ring-2 focus:ring-teal-200 outline-none">${cOpts}</select><input id="mk-ename" placeholder="Exam Name (e.g. Final)" class="border p-2.5 rounded-lg flex-1 text-sm focus:ring-2 focus:ring-teal-200 outline-none"><button onclick="loadSheet()" class="bg-teal-600 text-white px-6 rounded-lg font-bold text-sm hover:bg-teal-700 shadow">Load Sheet</button></div><div id="sheet-area" class="overflow-x-auto"></div></div></div>`;
            }

            // CMS
            else if(tab === 'cms') {
                 const w = db.website;
                 area.innerHTML = `
                 <div class="space-y-8 max-w-5xl pb-12">
                     <div class="flex justify-between items-center">
                         <h3 class="font-bold text-xl text-slate-700">Content Management</h3>
                         <button onclick="saveCMS()" class="bg-teal-900 text-white px-6 py-2 rounded-full font-bold shadow-lg hover:scale-105 transition"><i class="fas fa-save"></i> Save All Changes</button>
                     </div>

                     <!-- Hero -->
                     <div class="bg-white p-6 rounded-2xl shadow-sm border-t-4 border-blue-600">
                         <h3 class="font-bold mb-4 text-blue-800">Hero Section</h3>
                         <div class="space-y-3">
                             <input id="wb-bad" value="${w.hero.badge}" class="w-full border p-3 rounded-xl text-sm" placeholder="Badge Text">
                             <input id="wb-tit" value="${w.hero.title}" class="w-full border p-3 rounded-xl text-sm" placeholder="Title (HTML allowed)">
                             <textarea id="wb-dsc" class="w-full border p-3 rounded-xl text-sm" rows="3">${w.hero.desc}</textarea>
                         </div>
                     </div>
                     
                     <!-- About -->
                     <div class="bg-white p-6 rounded-2xl shadow-sm border-t-4 border-orange-500">
                         <h3 class="font-bold mb-4 text-orange-700">About Section</h3>
                         <div class="space-y-3">
                             <input id="ab-tit" value="${w.about.title}" class="w-full border p-3 rounded-xl text-sm" placeholder="About Title">
                             <textarea id="ab-dsc" class="w-full border p-3 rounded-xl text-sm" rows="3">${w.about.desc}</textarea>
                         </div>
                     </div>

                     <!-- Stats -->
                     <div class="bg-white p-6 rounded-2xl shadow-sm border-t-4 border-purple-600">
                         <div class="flex justify-between items-center mb-4">
                             <h3 class="font-bold text-purple-800">Statistics Counters</h3>
                             <button onclick="fetchStats()" class="text-xs bg-purple-100 text-purple-700 px-3 py-1.5 rounded-lg font-bold hover:bg-purple-200 transition"><i class="fas fa-sync-alt mr-1"></i> Auto-Fetch</button>
                         </div>
                         <div class="grid grid-cols-4 gap-4">
                             <input id="st-1" type="number" value="${w.stats.students}" class="border p-2 rounded-lg text-sm" placeholder="Students">
                             <input id="st-2" type="number" value="${w.stats.faculty}" class="border p-2 rounded-lg text-sm" placeholder="Faculty">
                             <input id="st-3" type="number" value="${w.stats.years}" class="border p-2 rounded-lg text-sm" placeholder="Years">
                             <input id="st-4" type="number" value="${w.stats.pass}" class="border p-2 rounded-lg text-sm" placeholder="Pass %">
                         </div>
                     </div>

                     <!-- Gallery -->
                     <div class="bg-white p-6 rounded-2xl shadow-sm border-t-4 border-pink-500">
                         <h3 class="font-bold mb-4 text-pink-700">Gallery (Image URLs)</h3>
                         <div class="flex gap-2 mb-4 bg-pink-50 p-3 rounded-xl">
                             <input id="gal-inp" placeholder="Paste Image URL" class="border p-2 rounded-lg flex-1 text-sm outline-none">
                             <button onclick="addGal()" class="bg-pink-600 text-white px-6 rounded-lg font-bold text-sm">Add</button>
                         </div>
                         <div class="grid grid-cols-5 gap-3">
                             ${w.gallery.map((img,i) => `
                                 <div class="relative group aspect-square">
                                     <img src="${img}" class="w-full h-full object-cover rounded-xl border-2 border-white shadow-sm">
                                     <button onclick="delWeb('gallery',${i})" class="absolute top-1 right-1 bg-red-500 text-white w-6 h-6 flex items-center justify-center rounded-full text-xs shadow hover:bg-red-600 transition">x</button>
                                 </div>
                             `).join('')}
                         </div>
                     </div>

                     <!-- Contact -->
                     <div class="bg-white p-6 rounded-2xl shadow-sm border-t-4 border-slate-600">
                         <h3 class="font-bold mb-4 text-slate-700">Contact Info</h3>
                         <div class="grid grid-cols-2 gap-4">
                             <input id="ct-ad" value="${w.contact.address}" class="border p-3 rounded-xl text-sm" placeholder="Address">
                             <input id="ct-ph" value="${w.contact.phone}" class="border p-3 rounded-xl text-sm" placeholder="Phone">
                             <input id="ct-em" value="${w.contact.email}" class="border p-3 rounded-xl text-sm" placeholder="Email">
                             <input id="ct-mp" value="${w.contact.mapUrl}" class="border p-3 rounded-xl text-sm" placeholder="Map Embed URL">
                         </div>
                     </div>

                     <!-- Notifications -->
                     <div class="bg-white p-6 rounded-2xl shadow-sm border-t-4 border-indigo-500">
                         <h3 class="font-bold mb-4 text-indigo-700">Notifications</h3>
                         <div class="flex gap-2 mb-4 bg-indigo-50 p-3 rounded-xl">
                             <input id="nf-txt" placeholder="Message" class="border p-2 rounded-lg flex-1 text-sm outline-none">
                             <input id="nf-lnk" placeholder="Link" class="border p-2 rounded-lg w-1/3 text-sm outline-none">
                             <button onclick="addNotif()" class="bg-indigo-600 text-white px-6 rounded-lg font-bold text-sm">Post</button>
                         </div>
                         <div class="space-y-2 max-h-48 overflow-y-auto">
                             ${w.notifications?.map((n,i)=>`<div class="flex justify-between p-3 border rounded-lg bg-white items-center"><div><p class="font-bold text-sm">${n.text}</p><p class="text-[10px] text-gray-400">${n.date}</p></div><button onclick="delNotif(${i})" class="text-red-400 hover:bg-red-50 p-2 rounded"><i class="fas fa-trash"></i></button></div>`).join('')}
                         </div>
                     </div>
                 </div>`;
            }

            // TEACHERS
            else if(tab === 'teachers') {
                renderCrudTab('teachers', 'Teachers List', 
                    `<div class="flex gap-2 mb-4 bg-white p-4 rounded-xl shadow-sm border">
                        <input id="t-name" placeholder="Full Name" class="border p-2.5 flex-1 rounded-lg text-sm focus:ring-2 focus:ring-teal-100 outline-none">
                        <input id="t-id" placeholder="Login ID" class="border p-2.5 w-32 rounded-lg text-sm focus:ring-2 focus:ring-teal-100 outline-none">
                        <input id="t-pass" placeholder="Password" class="border p-2.5 w-32 rounded-lg text-sm focus:ring-2 focus:ring-teal-100 outline-none">
                        <button id="btn-tea" onclick="saveTeacher()" class="bg-teal-600 text-white px-6 rounded-lg text-sm font-bold hover:bg-teal-700">Add</button>
                    </div>`,
                    db.teachers.map(t=>`<tr class="border-b hover:bg-slate-50"><td class="p-4 font-mono text-teal-600 font-bold text-xs">${t.uid}</td><td class="p-4 font-bold text-slate-700">${t.name}</td><td class="p-4 text-slate-400 text-xs">••••••</td><td class="p-4 text-right"><button onclick="editTeacher('${t.id}')" class="text-blue-500 mr-3 hover:text-blue-700"><i class="fas fa-edit"></i></button><button onclick="delItem('teachers','${t.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></td></tr>`).join('')
                );
            }

            // CLASSES
            else if(tab === 'classes') {
                const tOpts = `<option value="">Select Class Teacher</option>` + db.teachers.map(t=>`<option value="${t.id}">${t.name}</option>`).join('');
                renderCrudTab('classes', 'Class Management',
                    `<div class="flex gap-2 mb-6 bg-white p-4 rounded-xl shadow-sm border">
                        <input id="c-name" placeholder="Class Name (e.g. 10 A)" class="border p-2.5 flex-1 rounded-lg text-sm focus:ring-2 focus:ring-teal-100 outline-none">
                        <select id="c-tid" class="border p-2.5 rounded-lg bg-white text-sm focus:ring-2 focus:ring-teal-100 outline-none">${tOpts}</select>
                        <button id="btn-cls" onclick="saveClass()" class="bg-teal-600 text-white px-6 rounded-lg text-sm font-bold hover:bg-teal-700">Add</button>
                    </div>`,
                    db.classes.map(c=>{
                        const t=db.teachers.find(x=>x.id==c.teacherId);
                        const subCount = db.subjects.filter(s=>s.classId===c.id).length;
                        return `<div class="p-4 bg-white border rounded-xl shadow-sm flex justify-between items-center mb-3 hover:shadow-md transition"><div><span class="font-bold text-lg text-slate-800">${c.name}</span> <span class="text-sm text-slate-500 ml-2">(${t?t.name:'No Teacher'})</span></div><div class="flex gap-2"><button onclick="openSub('${c.id}')" class="text-xs bg-purple-100 text-purple-700 px-3 py-1 rounded-full font-bold hover:bg-purple-200 transition">Subjects (${subCount})</button><button onclick="editClass('${c.id}')" class="text-blue-500 p-2 hover:bg-blue-50 rounded"><i class="fas fa-edit"></i></button><button onclick="delItem('classes','${c.id}')" class="text-red-500 p-2 hover:bg-red-50 rounded"><i class="fas fa-trash"></i></button></div></div>`;
                    }).join(''), true
                );
            }

            // STUDENTS
            else if(tab === 'students') {
                const sorted = db.students.sort((a,b) => a.admNo.localeCompare(b.admNo, undefined, {numeric:true}));
                const cOpts = db.classes.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
                
                area.innerHTML = `
                <div class="grid md:grid-cols-3 gap-6 h-full pb-12">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border-t-4 border-teal-600 h-fit">
                        <h3 class="font-bold mb-4 text-slate-700">Add / Edit Student</h3>
                        <div class="space-y-3">
                            <input id="s-name" placeholder="Full Name" class="w-full border p-2.5 rounded-lg text-sm focus:ring-2 focus:ring-teal-100 outline-none">
                            <input id="s-adm" placeholder="Admission No" class="w-full border p-2.5 rounded-lg text-sm focus:ring-2 focus:ring-teal-100 outline-none">
                            <div class="grid grid-cols-2 gap-2">
                                <input id="s-dob" type="date" class="border p-2.5 rounded-lg text-sm">
                                <select id="s-gen" class="border p-2.5 rounded-lg text-sm bg-white"><option>Male</option><option>Female</option></select>
                            </div>
                            <select id="s-cid" class="w-full border p-2.5 rounded-lg text-sm bg-white"><option value="">Select Class</option>${cOpts}</select>
                            <button id="btn-stu" onclick="saveStudent()" class="w-full bg-teal-600 text-white py-2.5 rounded-lg font-bold hover:bg-teal-700 transition shadow">Add Student</button>
                        </div>
                        <div class="mt-6 pt-6 border-t border-slate-100">
                            <h4 class="font-bold text-xs mb-2 text-slate-500 uppercase">Tools</h4>
                            <div class="flex gap-2 mb-2">
                                <input type="file" id="bulk-file" accept=".xlsx" class="w-full text-xs">
                                <button onclick="bulkUpload()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-blue-700">Upload Excel</button>
                            </div>
                            <button onclick="exportStudents()" class="w-full bg-slate-700 text-white py-2 rounded text-xs font-bold hover:bg-slate-800"><i class="fas fa-download mr-1"></i> Download Student List</button>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm md:col-span-2 flex flex-col h-full border border-slate-100">
                        <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-700">Directory (${db.students.length})</h3><input onkeyup="filterStu(this.value)" placeholder="Search student..." class="border p-2 rounded-lg text-sm w-64 focus:ring-2 focus:ring-teal-100 outline-none"></div>
                        <div class="flex-1 overflow-y-auto custom-scrollbar rounded-lg border">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-slate-50 sticky top-0 text-slate-500 uppercase text-xs font-bold z-10"><tr><th class="p-3">Adm</th><th class="p-3">Name</th><th class="p-3">Class</th><th class="p-3 text-right">Action</th></tr></thead>
                                <tbody id="stu-tbody" class="divide-y divide-slate-100">${sorted.map(s=>{ const c=db.classes.find(x=>x.id==s.classId); return `<tr class="hover:bg-slate-50"><td class="p-3 font-mono text-teal-600 font-bold text-xs">${s.admNo}</td><td class="p-3 font-bold text-slate-700">${s.name}</td><td class="p-3"><span class="bg-slate-100 px-2 py-1 rounded text-xs">${c?c.name:'-'}</span></td><td class="p-3 text-right"><button onclick="editStudent('${s.id}')" class="text-blue-500 mr-3 hover:text-blue-700"><i class="fas fa-edit"></i></button><button onclick="delItem('students','${s.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></td></tr>`}).join('')}</tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
            }

            // PROFILE & SETTINGS
            else if(tab === 'profile') {
                area.innerHTML = `
                <div class="bg-white p-8 rounded-2xl shadow-sm max-w-lg mx-auto border border-slate-100">
                    <div class="text-center mb-6">
                        <div class="w-20 h-20 bg-teal-100 rounded-full flex items-center justify-center text-4xl text-teal-600 mx-auto mb-3"><i class="fas fa-cogs"></i></div>
                        <h3 class="font-bold text-xl text-slate-800">System Settings</h3>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="p-4 bg-slate-50 rounded-xl border border-slate-200">
                            <h4 class="text-sm font-bold text-slate-700 mb-3 border-b pb-2">Institution Details</h4>
                            <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Madrsa Name</label>
                            <input id="set-name" value="${db.settings.name}" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-teal-200 outline-none bg-white mb-1" placeholder="Enter Name">
                            <p class="text-[10px] text-slate-400">Used in Varisanghya Receipts.</p>
                        </div>

                        <div class="p-4 bg-slate-50 rounded-xl border border-slate-200">
                            <h4 class="text-sm font-bold text-slate-700 mb-3 border-b pb-2">Admin Credentials</h4>
                            <div class="mb-3"><label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Login Email</label><input id="pf-em" value="${db.admin.email}" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-teal-200 outline-none bg-white"></div>
                            <div><label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Login Password</label><input id="pf-ps" value="${db.admin.pass}" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-teal-200 outline-none bg-white"></div>
                        </div>
                        
                        <button onclick="saveAdmin()" class="w-full bg-teal-900 text-white py-3.5 rounded-xl font-bold hover:bg-teal-800 shadow-lg transition transform active:scale-95">Save All Settings</button>
                    </div>
                </div>`;
            }
        }

        // --- CRUD HELPERS ---
        function renderCrudTab(type, title, inputHtml, listHtml, isDiv=false) { 
            el('content-area').innerHTML = `<div class="bg-white p-6 rounded-2xl shadow-sm h-full flex flex-col border border-slate-100"><div class="flex justify-between items-center mb-6"><h3 class="font-bold text-xl text-slate-700">${title}</h3>${type==='teachers'?`<button onclick="exportData('teachers')" class="text-xs bg-slate-100 px-3 py-1 rounded hover:bg-slate-200"><i class="fas fa-download"></i> Export</button>`:''}</div>${inputHtml}<div class="flex-1 overflow-y-auto mt-4 custom-scrollbar border rounded-xl p-1 bg-white">${isDiv?`<div class="space-y-2">${listHtml}</div>`:`<table class="w-full text-sm text-left"><thead class="bg-slate-50 text-slate-500 font-bold sticky top-0 uppercase text-xs"><tr><th class="p-4">ID</th><th class="p-4">Name</th><th class="p-4">Creds</th><th class="p-4 text-right">Actions</th></tr></thead><tbody class="divide-y divide-slate-50">${listHtml}</tbody></table>`}</div></div>`; 
        }

        // --- LOGIC FUNCTIONS ---
        function handleSave(col, data) { const db=getDB(); if(editMode){const i=db[col].findIndex(x=>x.id===editMode); db[col][i]={...db[col][i],...data}; showToast('Updated Successfully');} else {db[col].push({id:genId(),...data}); showToast('Added Successfully');} saveDB(db); showTab(col); }
        
        function saveTeacher() { handleSave('teachers', {name:el('t-name').value, uid:el('t-id').value, pass:el('t-pass').value}); }
        function saveClass() { handleSave('classes', {name:el('c-name').value, teacherId:el('c-tid').value}); }
        function saveStudent() { handleSave('students', {name:el('s-name').value, admNo:el('s-adm').value, dob:el('s-dob').value, gender:el('s-gen').value, classId:el('s-cid').value}); }
        
        function editTeacher(id) { const x=getDB().teachers.find(i=>i.id===id); el('t-name').value=x.name; el('t-id').value=x.uid; el('t-pass').value=x.pass; editMode=id; el('btn-tea').innerText='Update'; }
        function editClass(id) { const x=getDB().classes.find(i=>i.id===id); el('c-name').value=x.name; el('c-tid').value=x.teacherId; editMode=id; el('btn-cls').innerText='Update'; }
        function editStudent(id) { const x=getDB().students.find(i=>i.id===id); el('s-name').value=x.name; el('s-adm').value=x.admNo; el('s-dob').value=x.dob; el('s-gen').value=x.gender; el('s-cid').value=x.classId; editMode=id; el('btn-stu').innerText='Update'; }
        
        function delItem(c,id) { if(confirm('Are you sure you want to delete this?')){const db=getDB(); db[c]=db[c].filter(x=>x.id!==id); saveDB(db); showTab(c);} }
        function saveAdmin() { const db=getDB(); db.admin={email:el('pf-em').value, pass:el('pf-ps').value}; db.settings.name=el('set-name').value; saveDB(db); showToast('Settings Saved'); }
        function filterStu(q) { const rows = document.getElementById('stu-tbody').getElementsByTagName('tr'); for(let r of rows) r.style.display = r.innerText.toLowerCase().includes(q.toLowerCase()) ? '' : 'none'; }
        function fetchStats() { const db = getDB(); el('st-1').value = db.students.length; el('st-2').value = db.teachers.length; showToast('Stats Fetched'); }

        // Subjects Logic
        function openSub(cid) { el('modal-sub').classList.remove('hidden'); el('active-cid').value=cid; el('new-sub-pass').value=lastPassMark; renderSub(cid); }
        function renderSub(cid) { const db=getDB(); const s=db.subjects.filter(x=>x.classId===cid); el('sub-list').innerHTML=s.map(x=>`<div class="flex justify-between p-3 bg-slate-50 rounded-lg text-sm border border-slate-100 mb-1"><span>${x.name} <span class="text-xs text-slate-400 ml-2">Pass: ${x.passMark}</span></span><button onclick="delSub('${x.id}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button></div>`).join(''); }
        function addSubject() { const n=el('new-sub').value; const p=el('new-sub-pass').value; const cid=el('active-cid').value; if(!n)return; const db=getDB(); db.subjects.push({id:genId(), name:n, passMark:p, classId:cid}); lastPassMark=p; localStorage.setItem('hihsm_last_pass',p); saveDB(db); el('new-sub').value=''; renderSub(cid); }
        function delSub(id) { const db=getDB(); db.subjects=db.subjects.filter(x=>x.id!==id); saveDB(db); renderSub(el('active-cid').value); }

        // Results Logic
        function loadSheet() {
            const cid=el('mk-cid').value; if(!cid)return; const db=getDB(); 
            const s=db.students.filter(x=>x.classId===cid).sort((a,b)=>a.admNo.localeCompare(b.admNo,undefined,{numeric:true})); 
            const sub=db.subjects.filter(x=>x.classId===cid);
            if(!s.length) return el('sheet-area').innerHTML='<p class="text-red-500 mt-2 p-4 bg-red-50 rounded">No students in this class.</p>';
            if(!sub.length) return el('sheet-area').innerHTML='<p class="text-yellow-600 mt-2 p-4 bg-yellow-50 rounded">No subjects defined.</p>';
            
            let h=`<table class="w-full text-sm border-collapse mt-4"><thead><tr class="bg-slate-100 text-slate-600"><th class="p-3 border text-left">Student</th>${sub.map(x=>`<th class="p-3 border text-center">${x.name}<br><span class="text-xs font-normal">Pass:${x.passMark}</span></th>`).join('')}</tr></thead><tbody>`;
            h+=s.map(x=>`<tr class="bg-white"><td class="p-3 border font-bold text-slate-700">${x.name} <span class="text-xs text-slate-400 block">${x.admNo}</span></td>${sub.map(b=>`<td class="p-2 border"><input type="number" class="w-full p-2 text-center mk-inp outline-none focus:bg-blue-50 rounded" data-sid="${x.id}" data-sub="${b.name}" data-pass="${b.passMark}"></td>`).join('')}</tr>`).join('');
            h+=`</tbody></table><button onclick="pubRes('${cid}')" class="mt-6 w-full bg-teal-600 text-white px-6 py-3 rounded-lg font-bold shadow hover:bg-teal-700">Publish Results</button>`;
            el('sheet-area').innerHTML=h;
        }
        function pubRes(cid) {
            const db=getDB(); const en=el('mk-ename').value; if(!en)return alert('Enter Exam Name');
            const s=db.students.filter(x=>x.classId===cid); const sub=db.subjects.filter(x=>x.classId===cid);
            let count=0;
            s.forEach(x=>{
                let m={}; let t=0; let p=true;
                sub.forEach(b=>{
                    const inp=document.querySelector(`.mk-inp[data-sid="${x.id}"][data-sub="${b.name}"]`);
                    const v=parseInt(inp?inp.value:0)||0; m[b.name]=v; t+=v; if(v<parseInt(b.passMark))p=false;
                });
                db.results.push({id:genId(), examName:en, studentId:x.id, marks:m, total:t, status:p?'PASS':'FAIL', date:new Date().toLocaleDateString(), isPublished:true, classId:cid});
                count++;
            });
            saveDB(db); showToast(`Published results for ${count} students`); showTab('results');
        }

        // Export/Import Logic
        function exportStudents() { exportData('students'); }
        function exportData(type) {
            const db=getDB(); const data=db[type];
            if(!data.length) return alert('No data to export');
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, type);
            XLSX.writeFile(wb, `${type}_data.xlsx`);
        }
        function bulkUpload() {
            const f = el('bulk-file').files[0]; const cid = el('s-cid').value;
            if(!f || !cid) return alert('Please select a Class and an Excel file');
            const r = new FileReader();
            r.onload = e => {
                try {
                    const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
                    const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
                    const db = getDB(); let c=0;
                    for(let i=1; i<rows.length; i++) { 
                        if(rows[i][0]) { 
                            db.students.push({id:genId(), name:rows[i][0], admNo:rows[i][1], dob:rows[i][2], gender:rows[i][3]||'Male', classId:cid}); 
                            c++; 
                        } 
                    }
                    saveDB(db); showTab('students'); showToast(`Imported ${c} students successfully`);
                } catch(err) { alert("Error reading file"); }
            };
            r.readAsArrayBuffer(f);
        }

        // CMS Logic
        function saveCMS() { 
            const db=getDB(); 
            // Save Hero
            db.website.hero={badge:el('wb-bad').value, title:el('wb-tit').value, desc:el('wb-dsc').value};
            
            // Save About
            db.website.about.title = el('ab-tit').value;
            db.website.about.desc = el('ab-dsc').value;

            // Save Stats
            db.website.stats = {
                students: el('st-1').value,
                faculty: el('st-2').value,
                years: el('st-3').value,
                pass: el('st-4').value
            };

            // Save Contact
            db.website.contact = {
                address: el('ct-ad').value,
                phone: el('ct-ph').value,
                email: el('ct-em').value,
                mapUrl: el('ct-mp').value
            };

            saveDB(db); showToast('Website Updated'); 
        }

        function addNotif() { const t=el('nf-txt').value; if(!t)return; const db=getDB(); db.website.notifications.unshift({id:genId(), text:t, link:el('nf-lnk').value||'#', date:new Date().toLocaleDateString()}); saveDB(db); showTab('cms'); }
        function delNotif(i) { if(confirm("Delete?")){const db=getDB(); db.website.notifications.splice(i,1); saveDB(db); showTab('cms');} }
        
        function addGal() { const u=el('gal-inp').value; if(!u)return; const db=getDB(); db.website.gallery.push(u); saveDB(db); showTab('cms'); }
        function delWeb(k,i) { if(confirm("Delete Image?")){const db=getDB(); db.website[k].splice(i,1); saveDB(db); showTab('cms');} }
    </script>
</body>
</html>